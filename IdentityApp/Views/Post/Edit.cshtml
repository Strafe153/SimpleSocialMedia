@model IdentityApp.ViewModels.EditPostViewModel

@{
    ViewData["Title"] = "Editing a post";
}

<form asp-action="Edit" asp-route-returnUrl="@Model.ReturnUrl" method="post" 
      enctype="multipart/form-data">
    <div asp-validation-summary="ModelOnly"
         class="validation alert alert-danger" role="alert"></div>

    <input type="hidden" asp-for="Id" value="@Model.Id" />
    <input type="hidden" asp-for="UserId" value="@Model.UserId" />
    <input type="hidden" asp-for="PostedTime" value="@Model.PostedTime" />

    <div class="form-group">
        <label for="post">Post</label><br />
        <textarea asp-for="Content" id="post"
                  class="form-control" rows="6"></textarea>

        <div class="mt-3 mb-1">
            @foreach (PostPicture postPicture in Model.PostPictures)
            {
                <span class="post-picture-container">
                    <img height="150" class="post-picture mb-1"
                         src="data:image/jpeg;base64,@(Convert.ToBase64String(
                                                     postPicture.PictureData))"
                         alt="post_picture" />
                    <a class="btn btn-sm btn-danger delete-button"
                       value="@postPicture.Id" style="color: #fff;">
                        Delete
                    </a>
                </span>
            }
        </div>

        <div class="form-group custom-file mt-1">
            <label class="custom-file-label" for="custom-file">
                Choose pictures
            </label>
            <input type="file" asp-for="AppendedPostPictures" id="custom-file"
                   class="custom-file-input" accept="image/jpeg,image/png"
                   multiple />
        </div>
    </div>
    <div class="form-group">
        @if (Model.ReturnUrl.Contains("Account"))
        {
            <a asp-action="Index"
               asp-controller="Account"
               asp-route-userName="@Model.UserName"
               class="btn btn-outline-secondary">
                Cancel
            </a>
        }
        else
        {
            <a asp-action="Index"
               asp-controller="Home"
               class="btn btn-outline-secondary">
                Cancel
            </a>
        }

        <input type="submit" class="btn btn-primary save-button" value="Save" />

        <a asp-action="Delete" asp-route-postId="@Model.Id"
           asp-route-returnUrl="@Model.ReturnUrl"
           class="d-inline float-right btn btn-danger">
            Delete
        </a>
    </div>
</form>

@section Scripts {
    <script type="text/javascript">
        let postPicturesToDelete = [];

        $(".delete-button").on("click", function(event) {
            let postPictureId = $(event.target).attr("value");

            $(event.target).parent().css("display", "none");
            postPicturesToDelete.push(postPictureId);
        });

        $(".save-button").on("click", function() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("Delete", "PostPicture")",
                data: {postPictureIds: postPicturesToDelete, postId: "@Model.Id"},
                dataType: "text"
            });
        });

        $(".custom-file-input").on("change", function () {
            $(".custom-file-label").text(
                `Pictures chosen: ${$(this)[0].files.length}`);
        });
    </script>
}